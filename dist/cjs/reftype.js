"use strict";class e{values;calc;constructor(e,t){this.values=e,t&&(this.calc=t)}set(e,t){return this.values[e]=t,this.calc?this.calc(...this.values.filter(((e,t)=>""!==e||!(t%2)))):this.values.join("")}}function t(e,t,s,i){let r,n;s.hasOwnProperty(e)?r=s[e]:s[e]=r=new Map,r.has(t)?n=r.get(t):r.set(t,n=new Set),n.add(i)}class s{refs;elements;options;parent;attrs;props;multiValues;children;hidden;constructor(e,t,s){this.refs=e,t&&(this.options=t),s&&(this.parent=s)}createMultiValue(t,s){const i=t.split(this.options?.sep?.multivalue||l.sep.multivalue),r=[];let n;for(let e=0;e<i.length;e+=2)n=i[e].trim(),r.push(n),i[e]=this.get(n);return{refs:r,values:new e(i,s)}}addValue(e,s,i,r){let n,h;const o=this.options?.sep?.calc||l.sep.calc;if((e=e.trim()).indexOf(o)>=0&&([n,e]=e.split(o,2),n=n.trim(),h=this.options?.calc?.[n]||l.calc[n],!h))throw new TypeError(`The calculation ${n} could not be found`);if(e=e.trim(),h||e.indexOf(this.options?.sep?.multivalue||l.sep.multivalue)>=0){const{refs:n,values:l}=this.createMultiValue(e,h),o={name:r,values:l};let f=0;for(let e of n)t(e,s,i,Object.assign({index:f},o)),f+=2}else t(e,s,i,r)}add(...e){const t=this.options?.suffix?.attr||l.suffix.attr,s=this.options?.suffix?.prop||l.suffix.prop,i=this.options?.attr?.text||l.attr.text,r=this.options?.attr?.ref||l.attr.ref,n=this.options?.attr?.iter||l.attr.iter,o=this.options?.attr?.closed||l.attr.closed,f={[r]:this.options?.ref||l.ref,[n]:this.options?.iter||l.iter};let a,d,p,c,u,m;for(let l of e){if(u=!1,!this.elements||!this.elements.includes(l)){for(c of[r,n])l.hasAttribute(c)&&(p=l.getAttribute(c),c===n&&p.startsWith("{")&&p.endsWith("}")?(m=!0,p=p.slice(1,-1)):m=!1,this.children||(this.children={}),this.children.hasOwnProperty(p)?a=this.children[p]:this.children[p]=a=new f[c](this.get(p),this.options,this),m&&a instanceof h&&(a.addIndex=!0),a.elements=[l],a.add(l),u=!0);if(u)continue}for(d of l.attributes)d.name!==o&&(d.name===i?(this.props||(this.props={}),this.addValue(l.textContent,l,this.props,"textContent")):d.name.endsWith(t)?(this.attrs||(this.attrs={}),this.addValue(d.value,l,this.attrs,d.name.slice(0,-t.length))):d.name.endsWith(s)&&(this.props||(this.props={}),this.addValue(d.value,l,this.props,d.name.slice(0,-s.length))));let e=l.firstElementChild;for(;e;)e.hasAttribute(o)||this.add(e),e=e.nextElementSibling}}remove(e){if(e){if(this.children)for(let t of Object.keys(this.children))t.startsWith(e)&&delete this.children[t];if(this.attrs)for(let t of Object.keys(this.attrs))t.startsWith(e)&&delete this.attrs[t];if(this.props)for(let t of Object.keys(this.props))t.startsWith(e)&&delete this.props[t]}else delete this.children,delete this.attrs,delete this.props;return this}react(...e){if(null===this.refs&&!this.hidden)return this.hide();if(this.hidden&&null!==this.refs&&this.show(),e.length){let t,s,h,o,f,a;for(a of(1===e.length&&"object"==typeof e[0]&&(t=e[0],e=Array.from(Object.keys(e[0]))),this.hidden&&null!==this.refs&&this.show(),e)){if(f=t?t[a]:this.get(a),this.attrs)for([h,o]of Object.entries(this.attrs))h.startsWith(a)&&i(o,f,r);if(this.props)for([h,o]of Object.entries(this.props))h.startsWith(a)&&i(o,f,n);this.children?.hasOwnProperty(a)&&(s=this.children[a],void 0!==f?(s.refs=f,s.react()):(s.delete(),delete this.children[a])),a!==this.options?.self&&a!==l.self||(void 0!==f?this.react():this.delete())}}else{if(this.attrs)for(let[e,t]of Object.entries(this.attrs))i(t,this.get(e),r);if(this.props)for(let[e,t]of Object.entries(this.props))i(t,this.get(e),n);if(this.children)for(let[e,t]of Object.entries(this.children))t.refs=this.get(e),t.react()}return this}set(e){let t;for(let[s,i]of Object.entries(e))t=this.destructure(s),t.parent[t.prop]=i;return this.react(e),this}delete(e){if(void 0===e){if(this.elements)for(let e of this.elements)e.remove()}else{const t=this.destructure(e);delete t.parent[t.prop],this.children?.hasOwnProperty(e)?this.children[e].delete():this.react({[e]:void 0})}return this.remove(e)}call(e,...t){const s=this.destructure(e),i=s.parent[s.prop](...t);return this.react({[e]:i}),i}destructure(e){if("string"!=typeof e||!e.trim())return null;if(e===this.options?.self||e===l.self)return{parent:this,prop:"refs"};const t=e.split(this.options?.sep?.ref||l.sep.ref);let s=this.refs,i=this.parent,r=t[0],n=s[r];for(;void 0===n&&i;)s=i.refs,n=s[r],i=i.parent;if(void 0!==n)for(let e=1;e<t.length&&(s=n,r=t[e],n=s[r],void 0!==n);e++);return{parent:s,prop:r}}get(e){if("string"!=typeof e||!e.trim())return"";if(e===this.options?.self||e===l.self)return this.refs;const t=this.destructure(e);if(!t)return;const s=t.parent[t.prop];return void 0!==s?s:void 0}hide(){let e;for(e of(this.hidden=new Map,this.elements))this.hidden.set(e,e.style.display),e.style.display="none"}show(){if(this.hidden){for(let[e,t]of this.hidden.entries())e.style.display=t;delete this.hidden}}}function i(e,t,s){let i;for(let[r,n]of e.entries())for(i of n)"string"==typeof i?s(r,i,t):s(r,i.name,i.values.set(i.index,t))}function r(e,t,s){void 0!==s?e.setAttribute(t,s):e.removeAttribute(t)}function n(e,t,s){e[t]=s,void 0===s&&delete e[t]}class h extends s{items;addIndex;templates;getTemplate(e,t){this.templates||(this.templates=new WeakMap);let s=this.templates.get(e);return s&&!t||(1===e.children.length?s=e.firstElementChild instanceof HTMLTemplateElement?e.firstElementChild.content:e.firstElementChild:(s=document.createDocumentFragment(),s.append(...e.childNodes)),this.templates.set(e,s)),s}add(...e){this.elements||(this.elements=[]),this.items||(this.items=new WeakMap);for(let t of e)this.elements.push(t),this.items.set(t,[]),this.getTemplate(t,!0);return this.reactOn(...e),this}react(...e){if(null===this.refs&&!this.hidden)return this.hide();if(this.hidden&&null!==this.refs&&this.show(),this.items||(this.items=new WeakMap),e.length){let t,s,i,r,n;1===e.length&&"object"==typeof e[0]&&(s=e[0],e=Array.from(Object.keys(s)));for(let h of e)if(i=s?s[h]:this.get(h),h!==this.options?.self&&h!==l.self)for(r of this.elements)n=this.items.get(r),n.hasOwnProperty(h)&&(t=n[h],this.addIndex?t.refs={item:i,index:"number"==typeof h?h:parseInt(h)}:t.refs=i,t.react());else this.refs=i,this.react()}else{let e;for(e of(this.items=new WeakMap,this.remove(),this.elements))e.textContent="",this.items.set(e,[]);for(let t of this.refs)for(e of this.elements)this.addChild(e,t)}return this}reactOn(...e){if(null===this.refs&&!this.hidden)return this.hide();let t;for(t of(this.hidden&&null!==this.refs&&this.show(),this.items||(this.items=new WeakMap),e))t.textContent="",this.items.set(t,[]);for(let s of this.refs)for(t of e)this.addChild(t,s)}createChild(e,t,s){const i=new(this.options?.item||l.item)(this.addIndex?{index:t,item:s}:s,this.options,this),r=this.templates.get(e);if(r instanceof Element){const e=r.cloneNode(!0);i.elements=[e],i.add(e)}else r instanceof DocumentFragment&&(i.elements=Array.from(r.cloneNode(!0).children),i.add(...i.elements));return i.react(),i}addChild(e,t,s){const i=this.items.get(e),r=this.createChild(e,i.length,t),n=void 0!==s&&e.children.length>s?e.children[s]:null;if(n)for(let t of r.elements)e.insertBefore(t,n);else e.append(...r.elements);i.push(r)}push(...e){let t,s;this.refs.push&&(t=this.refs.push(...e));for(let t of e)for(s of this.elements)this.addChild(s,t);return t}pop(){let e,t;this.refs.pop&&(e=this.refs.pop());for(let e of this.elements)t=this.items.get(e),t.at(-1).delete(),t.pop();return e}splice(e,t,...s){let i;this.refs.splice&&(i=this.refs.splice(e,t,...s));for(let i of this.elements){const r=this.items.get(i),n=s.map(((t,s)=>this.createChild(i,e+s,t)));for(let s=0;s<t;s++)r[e+s].delete();if(r.splice(e,t,...n),this.addIndex)for(let t=e;t<r.length;t++)r[t].set({index:t+s.length});let h;const l=this.templates.get(i),o=(l instanceof DocumentFragment?l.children.length:1)*e;if(i.children.length>o){const e=i.children[o];for(let t of n)for(h of t.elements)i.insertBefore(h,e)}else for(let e of n)i.append(...e.elements)}return i}move(e,t,s){if(e===t)return;const i={[e]:t};let r,n,h;s&&(i[t]=e);const l=this.refs.slice();let o,f,a,d,p,c,u,m=0;for(let g of this.elements){for(c of(m++,r=this.items.get(g),o={},Object.keys(i)))o[c]=r[c];for(c of(f={},Object.values(i)))u=r[c],f[c]=u.elements.at(-1).nextSibling||[u.elements[0].parentNode];for([e,t]of Object.entries(i)){if("string"==typeof e&&(e=parseInt(e)),h=o[e],p=f[t],p instanceof Array)for(a of(d=p[0],h.elements))d.appendChild(a);else for(a of(d=p.parentNode,h.elements))d.insertBefore(a,p);if(s)1===m&&(this.refs[t]=l[e]),r[t]=h;else{if(this.addIndex)if(e>t)for(n=t;n<e;n++)r[n].set({index:n+1});else for(n=e+1;n<=t;n++)r[n].set({index:n-1});1===m&&this.refs.splice(t,0,...this.refs.splice(e,1)),r.splice(t,0,...r.splice(e,1))}this.addIndex&&h.set({index:t})}}return this}delete(e){if(void 0===e){if(this.refs.length=0,this.elements){for(let e of this.elements)e.remove();delete this.elements}return delete this.templates,delete this.items,this.remove()}this.splice("string"==typeof e?parseInt(e):e,1)}}const l={suffix:{attr:"-a",prop:"-p"},attr:{text:"t",ref:"re-f",iter:"ite-r",closed:"close-d"},sep:{ref:".",multivalue:"|",calc:":="},calc:{add(...e){let t=0;for(let s of e)"string"==typeof s&&(s=(s.indexOf(".")>=0?parseFloat:parseInt)(s.trim())),t+=s;return t}},ref:s,iter:h,item:s,self:"."};exports.IterRefType=h,exports.MultiValue=e,exports.RefType=s,exports.addRef=t,exports.options=l,exports.react=i,exports.setAttr=r,exports.setProp=n;
